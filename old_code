#//////////////////////////
#main.pyçš„å…§å®¹
#//////////////////////////

'''
#ç™»å…¥å¾Œçš„é¸å–®
class menu(discord.ui.View):
    def __init__(self,user_id=None):
        super().__init__(timeout=None)
        self.user_id=user_id if user_id is not None else None

        self.custom_id = menu.__qualname__

        #self.add_itemæ˜¯ç”¢ç”ŸæŒ‰éˆ•çš„èªæ³•
        self.add_item(discord.ui.Button(label="æ–°å¢ç´€éŒ„",custom_id="action_add",style=discord.ButtonStyle.green,row=0))
        self.add_item(discord.ui.Button(label="æŸ¥è©¢ç´€éŒ„",custom_id="action_search",style=discord.ButtonStyle.grey,row=0))
        self.add_item(discord.ui.Button(label="ä¿®æ”¹ç´€éŒ„",custom_id="action_edit",style=discord.ButtonStyle.blurple,row=0))
        self.add_item(discord.ui.Button(label="åˆªé™¤ç´€éŒ„",custom_id="action_delete",style=discord.ButtonStyle.red,row=1))
        self.add_item(discord.ui.Button(label="åœ–è¡¨åˆ†æ",custom_id="action_analyze",style=discord.ButtonStyle.green,row=1))
        self.add_item(discord.ui.Button(label="ç™»å‡ºç³»çµ±",custom_id="action_signout",style=discord.ButtonStyle.green,row=1))
        
            
    #ç•¶æŒ‰éˆ•è¢«æŒ‰ä¸‹
    async def interaction_check(self,interaction:discord.Interaction):
        custom_id=interaction.data["custom_id"]
        print(logged_in_users)
        print(str(interaction.user.id),self.user_id)
        # ğŸ¯ æª¢æŸ¥æ“ä½œè€…æ˜¯å¦ç‚ºæœ¬äºº
        if str(interaction.user.id) != self.user_id:
            await interaction.response.send_message("ä½ ä¸èƒ½æ“ä½œåˆ¥äººçš„é¸å–®ã€‚", ephemeral=True)
            return
        #åˆ¤æ–·æŒ‰ä¸‹çš„æ˜¯å“ªå€‹æŒ‰éˆ•ï¼Œä»¥é€²å…¥è©²åŠŸèƒ½
        if custom_id=="action_add":
            await interaction.response.send_modal(add_record_modal(parent_view=self))
        elif custom_id=="action_search":
            embed=search_records_embed(parent_view=self).get_embed()
            await interaction.response.send_message(content="æŸ¥è©¢çµæœï¼š",embed=embed,view=BackView(parent_view=self),ephemeral=False)  # â† æ¸…é™¤åŸæœ¬æŒ‰éˆ•ï¼Œæä¾›è¿”å›éµ
        elif custom_id=="action_edit":
            await interaction.response.send_modal(edit_record_modal(parent_view=self))
        elif custom_id=="action_delete":
            await interaction.followup.send(delete_record_modal(title="åˆªé™¤è¨˜å¸³è¨˜éŒ„", parent_view=self))
        elif custom_id=="action_analyze":
            await interaction.followup.send("åœ–è¡¨åˆ†æåŠŸèƒ½å³å°‡æ¨å‡º...", ephemeral=True)
        elif custom_id=="action_signout":
            logged_in_users[self.user_id]=False
            await interaction.followup.edit_message(content="**âœ… æˆåŠŸç™»å‡ºï¼** è«‹ä½¿ç”¨ `/ç™»å…¥` å†æ¬¡æ“ä½œã€‚", view=None)

#è¿”å›é¸å–®çš„æŒ‰éˆ•
class BackView(discord.ui.View):
    def __init__(self, parent_view: discord.ui.View):
        super().__init__(timeout=None)
        self.parent_view = parent_view

    @discord.ui.button(label="è¿”å›ä¸»é¸å–®", style=discord.ButtonStyle.primary)
    async def back(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.edit_message(content="ä¸»é¸å–®ï¼š",view=self.parent_view)       # â† å›åˆ°åŸæœ¬é¸å–®
'''


# #æ–°å¢æ¶ˆè²»åŠŸèƒ½
# @bot.slash_command(name="æ–°å¢",description="æ–°å¢æ¶ˆè²»")
# async def add_cost(ctx,item,amount,type: Option(str, "é¸æ“‡æ”¶æ”¯é¡å‹", choices=["æ”¶å…¥", "æ”¯å‡º"])):#æˆ‘ä¹Ÿä¸çŸ¥é“ç‚ºç”šéº¼æœƒæœ‰é»ƒè‰²æ³¢æµªè™Ÿï¼Œä½†èƒ½è·‘å°±è¡Œ
#     await ctx.defer()   # ğŸ”¥ å‘Šè¨´ Discordï¼šæˆ‘åœ¨è™•ç†ä¸­
#     user_id = str(ctx.author.id)
#     today = datetime.date.today()
#     db.add_record(user_id,today,item,amount,type)
#     await ctx.respond("æˆåŠŸè¨˜å…¥å¸³æœ¬")

# #æŸ¥è©¢å¸³æœ¬åŠŸèƒ½
# @bot.slash_command(name="æŸ¥è©¢",description="æŸ¥è©¢å¸³æœ¬")
# async def search_records(ctx):
#     user_id=str(ctx.author.id)
#     rows=db.search_records(user_id)
#     # è¡¨é ­
#     embed = Embed(title="ğŸ“’ è¨˜å¸³ç´€éŒ„")

#     for r in rows:
#         id, user_id, today, item, amount, category = r
#         embed.add_field(
#             name=f"ID: {id}",
#             value=f"ğŸ“… {today}\nğŸ“Œ {item}\nğŸ’µ {amount}\nğŸ”– {category}",
#             inline=False
#         )
#     await ctx.respond(embed=embed)   # ç”¨ code block å›ºå®šå¯¬åº¦

# #ä¿®æ”¹å¸³æœ¬åŠŸèƒ½
# @bot.slash_command(name="ä¿®æ”¹",description="ä¿®æ”¹å¸³æœ¬")
# async def edit_record(ctx,id,item,amount):
#     user_id=str(ctx.author.id)
#     db.edit_record(id,user_id,item,amount)
#     await ctx.respond(f"å·²ä¿®æ”¹ç¬¬{id}ç­†è¨˜éŒ„")

# #ç”Ÿæˆæ¶ˆè²»åˆ†æåœ–è¡¨



# #æ©Ÿå™¨äºº(ç·´ç¿’)
# @bot.event
# async def on_message(message):#å®šç¾©
#     if message.author==bot.user:#åµæ¸¬åˆ°çš„è¨Šæ¯ä¾†æºç­‰æ–¼æ©Ÿå™¨äººæœ¬èº«å‰‡è·³å‡ºï¼Œé¿å…bug
#         return
#     if message.content=="hellow":#åµæ¸¬è¨Šæ¯å…§å®¹æ˜¯å¦ç¬¦åˆ
#         await message.channel.send("hi")
#     if message.content.startswith("æ¸¬è©¦"):#åµæ¸¬å…§å®¹é–‹é ­æ˜¯å¦ç¬¦åˆ
#         await message.channel.send("æ¸¬è©¦æˆåŠŸ")
# #æ©Ÿå™¨äºº(ç·´ç¿’)
# @bot.event
# async def on_member_join(member):
#     channel_id=1442521104315846838
#     welcome_channel=bot.get(channel_id)
#     await welcome_channel.send(f"æ­¡è¿{member.mention}åŠ å…¥ä¼ºæœå™¨")



#//////////////////////////
#database.pyçš„å…§å®¹
#//////////////////////////


# import psycopg2 #postgresçš„å¯«æ³•
# import os
# from dotenv import load_dotenv

# load_dotenv()

# class recordDB:#è³‡æ–™åº«çš„é¡åˆ¥
#     #è¨­å®šé€™å€‹é¡åˆ¥çš„å±¬æ€§
#     def __init__(self,db_url=os.environ.get("DATABASE_URL")):
#         self.db_url=db_url
#         self.init_db()
#     #é–‹å§‹è¨­å®šæ–¹æ³•
#     #ä¾ç‰©ä»¶çš„åç¨±å»ºç«‹sqliteé€£ç·š
#     def connect(self):
#         return psycopg2.connect(self.db_url)
#     #å»ºç«‹è³‡æ–™è¡¨
#     def init_db(self):
#         conn=self.connect()
#         cursor=conn.cursor()
#         #åŸ·è¡Œsqliteèªæ³•(spliteçš„ä¾åºçµ¦keyæ˜¯ç”¨INTEGER)
#         cursor.execute("""CREATE TABLE IF NOT EXISTS records (
#                         id SERIAL PRIMARY KEY,
#                         user_id TEXT,
#                         today DATE,
#                         item TEXT,
#                         amount INTEGER,
#                         type TEXT
#                         )""")
#         conn.commit()
#         conn.close()
#     #æ–°å¢è³‡æ–™åˆ°è³‡æ–™è¡¨
#     def add_record(self,user_id,today,item,amount,type):
#         conn=self.connect()
#         cursor=conn.cursor()
#         #åŸ·è¡Œsqliteèªæ³•(spliteç”¨?,psycopg2ç”¨%s)
#         cursor.execute("INSERT INTO records (user_id,today,item,amount,type) VALUES(%s,%s,%s,%s,%s)",(user_id,today,item,amount,type))
#         conn.commit()
#         conn.close()
#     #æŸ¥è©¢ä½¿ç”¨è€…çš„æ‰€æœ‰è³‡æ–™
#     def search_records(self,user_id):
#         conn=self.connect()
#         cursor=conn.cursor()
#         cursor.execute("SELECT * FROM records WHERE user_id=(%s)",(user_id,))
#         rows=cursor.fetchall()
#         conn.close()

        
#         return rows
#     #ä¿®æ”¹æŸä¸€ç­†è³‡æ–™çš„å…§å®¹(æ„Ÿè¦ºæœ‰é»é›£ä¹‹å¾Œå†åš)
#     def edit_record(self,id,user_id,item,amount):
#         conn=self.connect()
#         cursor=conn.cursor()
#         cursor.execute("SELECT user_id FROM records WHERE id=(%s)",(id,))
#         x=cursor.fetchone()
#         print(x[0])
#         if x[0]==user_id:
#             cursor.execute("UPDATE records SET item=%s,amount=%s WHERE id=%s",(item,amount,id,))
#             print("æˆåŠŸ")
#         else:
#             print("å¤±æ•—")
#         conn.commit()
#         conn.close()
#     #åˆªé™¤æŸä¸€ç­†ç‰¹å®šè³‡æ–™
#     def delete_record(self,id):
#         conn=self.connect()
#         cursor=conn.cursor()
#         cursor.execute("DELETE FROM records WHERE id=(%s)",(id,))
#         conn.commit()
#         conn.close()